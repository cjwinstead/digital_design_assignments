\documentclass[10pt, onecolumn]{scrartcl}
\input{preamble.tex}

\usepackage{amsmath, graphicx}
\usepackage{xcolor}
% \usepackage[top=1in, bottom=1in, left=1in, right=1in, includefoot]{geometry}
\usepackage{fancyvrb}
\usepackage[unicode=true]{hyperref}

\begin{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{ECE 2700 Lab 3\\Arithmetic Circuits}
\subtitle{Due at the end of your registered lab session (100 points)}
\date{}
\maketitle

\vspace{-0.5in}

\begin{center}
{\Large Objectives} \\
\vspace{0.1cm}
\begin{itemize}
\item Design two adder circuits using Verilog: a ripple-carry adder and a carry-select adder.
\item Design effective testbenches to verify each adder's correctness
  through simulation.
\item Learn to read synthesis report generated by Vivado to find out
  the size and speed information.
\item Understand the size of performance tradeoffs between two adder
  designs.
\item Implement the adder circuits on Basys 3 FPGA board, provide
  external stimulus using switches, and observe the output on LEDs.  
\end{itemize}
\end{center}
\section{Introduction}
A MUX has one output \texttt{out}, two signal inputs \texttt{i0} and \texttt{i1}, and a {\em select} input \texttt{sel}. When \texttt{sel==0}, the output is assigned to equal \texttt{i0}. When \texttt{sel==1}, the output is assigned to equal \texttt{i1}. This behavior can be written algebraically as 
\[ \texttt{out} = \texttt{sel}\cdot \texttt{i1} + \overline{\texttt{sel}}\cdot \texttt{i0}. \]

A \emph{carry-select} adder includes two 4-bit ripple-carry adders per section. One ripple-carry adder computes the sum and carry bits assuming the carry-in is 0, while the other computes them assuming the
carry-in is 1. Once the carry-in is known, it is used as the select to multiplexors to choose the appropriate sum and carry-out bits. One
4-bit section of a carry-select adder is shown in Figure~\ref{fig:oneSec4bitCarrySel}.

\section{Pre-Lab Preparation}

\begin{enumerate}
% \item Use multiple 2-to-1 MUXes to construct a 4-to-1 MUX. You can use inverters if needed.

\item Take Lab 3 Quiz before the start of the first Lab session for Lab3

\item Suppose we want to switch between three-bit numbers \texttt{a} and \texttt{b} (i.e.\ \texttt{a} has digits \texttt{a0}, \texttt{a1}, and \texttt{a2}, and \texttt{b} is also a vector of three bits). How would you interconnect 2-to-1 MUXes in order to select \texttt{a} if \texttt{sel==1}, or \texttt{b} if \texttt{sel==0}?
\item Describe a 4-bit section of a carry-select adder in Verilog. Present your hierarchical design using a block diagram first. A hierarchical design means that you should first write Verilog code for a 1-bit full-adder, instantiate your full-adder to build a
4-bit ripple carry adder, and, finally, instantiate your 4-bit ripple
carry adder with multiplexors to construct your carry-select
adder. For the 1-bit full adder Verilog description, you may use
either assign statements or gate instantiations, or both. 
%You are \textbf{not} allowed to use always blocks for this lab. Also, don't use the ``+'' operator in this lab.}%

\textbf{Always blocks (and especially "+" operators) are only to be used for testbenches.}


\item Assuming the delay of a 4-bit ripple carry adder is 4 and a
  multiplexor is 1, compare the delay of a 16-bit ripple carry adder
  to a 16-bit carry-select adder.
\end{enumerate}

\begin{figure}[htb]
  \includegraphics[width=\textwidth]{images/oneSec4bitCarrySel}
  \caption{Block diagram for a 4-bit section of a carry-select adder.}\label{fig:oneSec4bitCarrySel}
\end{figure}

\section{Overview}
In this lab, you will design, simulate, synthesize, and implement ripple-carry and
carry-select adders. Starting with 4-bit adders, you will use
\emph{structural} Verilog to provide their hierarchical
description. Then you will instantiate these adders to build 16-bit
adders. For each adder design, you will learn to read reports generated by the synthesis process to
extract the area and delay information.

\section{MUX Module}
%Close Impact and return to ISE. 
If you have not already, create a new project in Vivado named \texttt{MUX}, and create a new module called \texttt{mux.v} with the following I/O signals:

\begin{center}
\begin{tabular}{cccc}
direction & name & vector & bits \\
\hline
\texttt{input} & \texttt{i} & yes & 1:0 \\ 
\texttt{input} & \texttt{sel} & no & -- \\ 
\texttt{output} & \texttt{o} & no & -- 
\end{tabular}
\end{center}

Define the correct MUX behavior using \texttt{assign statements} or \texttt{gate instantiations}. Create a clocked testbench, remember that you can't use an always block in this lab, 
%similar to the one we made for the decoder module,% we haven't talked about decoders yet 
and verify your design in simulation. If you are uncertain with your solution, ask the TA to confirm your simulation result. Then customize the XDC constraint file as before. Use \texttt{sw0} and \texttt{sw1} as the input \texttt{i}, \texttt{sw2} as \texttt{sel}, and \texttt{LED0} as the output. 
%Program your board, verify the behavior, and demonstrate it to your TA.
\newline \textbf{TA PASS OFF: Show to and explain to your TA your simulation, and implementation for the MUX module}

\section{Simulation Tips}
Nothing to do in this section, but contains useful tips that will help you debug your designs.
After launching a simulation, the window changes slightly and you will notice the following tool bar has been added.
\begin{center}
	\includegraphics[width=4in]{images/sim_tools.png}
\end{center}
The first button that is used a lot, is the run for time period, denoted by the play button with a (T) subscript. After clicking it, the simulation will run for an additional time period set in the tool bar, in this case it's 10 micro seconds. Do not click the first play button if you do not have a \textbf{\$finish} statement in your testbench like in lab 1. Without it, the simulation will run forever and may eventually crash Vivado.
Another useful button is the relaunch simulation button, denote by the circular arrow. This is faster than closing the simulation and reopening it. If you make changes to you testbench or verilog modules, you can press this button to relaunch the simulation and see the new results. If you changed which testbench you are running, you must close the simulation and relaunch it however.\\

\begin{center}
	\includegraphics[height=2in]{images/simulation_errors.png}
\end{center}
The above screenshot shows some common simulation errors where the inputs/outputs are red (X) or blue (Z). For the blue signals, this is caused by a net not being connected to an input or output. If the red signal is an input to the DUT, this means that you have not initialized the input in your testbench. If the red signal is an output from the DUT, then this means that either the inputs have not propagated to the outputs or the output never gets set in the design. Remember to initialize all of your inputs in the testbench to help mitigate this problem.
\begin{center}
	\includegraphics[width=\textwidth]{images/add_signals_to_sim.png}
\end{center}
By default, only the top signals declared in your testbench will show up on the waveform window. Sometimes, it's useful to dig deeper into sub-modules and sub-signals to find out what may be causing an error. To do this, click on the scope window and then on the drop down for the testbench. There you will find all the modules that are being tested, click on one of the submodules then the objects window will show all the signals in that module. From here you can right click and add them to the waveform window. You must relaunch the simulation to see the changes take effect.

\begin{center}
	\includegraphics[width=\textwidth]{images/RTL_Schematic.png}
\end{center}
One last tip, sometimes it may be hard to verify that all the connections between modules are correct just by looking at the Verilog code. Thankfully, Vivado provides a graphical representation of the design. This can be found by clicking the \texttt{RTL ANALYSIS} drop down then the \texttt{Open Elaborated design} drop down. Here you will find a \texttt{Schematic} option, click on it and it should open up a diagram like the above screenshot (this is of the carry select adder, notice how it matches the block design at the end of this PDF). This makes it much easier to follow connections down into sub modules. You can expand the module to see whats underneath by clicking the \textbf{+} symbol next to each module. As an added bonus, when you open the RTL schematic it also performs a check on your constraints file. If you have errors in your constraints file, running RTL analysis is much faster to report back problems than waiting for synthesis and implementation to run just to report back an error.

\section{Design a 4-bit ripple-carry adder}
\begin{enumerate}
\item Create a Verilog module for a 1-bit full adder. You may use
  either assign statements or gate instantiations, or both. 
  \textbf{An always block and "+" operator can only be located, and must be used in your testbench.}
  %You are \textbf{not} allowed to use always blocks for this lab. Also, donâ€™t use the ``+'' operator in this lab.
  
\item Instantiate four 1-bit full adders to design a 4-bit
  ripple-carry adder.
\item Provide a testbench for your 4-bit ripple-carry adder. Simulate
  it and verify that it operates correctly.
\item Turn off optimization options in the implementation settings, and then synthesize the adder to generate the implementation. This process generates:
  \begin{itemize}
    \item a \emph{register-transfer level} (RTL) schematic,
    \item synthesis report,
    \item map report, and
    \item place \& route report.
  \end{itemize}
   To access these reports, select \textit{open implemented design} in the pop up window after the implementation has finished running. (Alternatively, if you have an up-to-date implementation, you can select it from the side menu any time). Once you have opened the design, you can open the reports you want to view from the side menu. 
   
   \begin{center}
	\includegraphics[width=\textwidth]{images/open_imp_design.png}
    \end{center}
   
   One final note on viewing the timing information. Often times, designers want to know what the critical path is (the path from input to output that takes the longest amount of time). This is most easily viewed on the timing report. In the upper toolbar select \textit{reports} then \textit{timing} and \textit{report timing}. Make sure you have both the RTL schematic and the timing report open. From there, you can click on any path in the report and it will highlight it in blue on the schematic for you to visualize. The critical path should be listed first. 
   
    \begin{center}
	\includegraphics[width=\textwidth]{images/timing_report.png}
    \end{center}
   
   Analyze these carefully, and see what can you decipher from them.
\item Identify the following information from these reports: 
  \begin{itemize}
    \item Area of the design, specified in terms of the number of
      slices and look-up tables (Utilization Report).
    \item Delay of the design, i.e., the longest/slowest path of the circuit (Timing Summary Report, Data Sheet, Combinational Delays).
  \end{itemize}  
Compare the longest path to your expected longest path of your
ripple-carry adder. Does the report agree with your expectation?
\item If you view the generated RTL schematic, you will find that the generated design closely matches your structural Verilog code. This result is due to the fact that you used a structural description, and you are asking the compiler to design it just as you described it.
\item Simulate the design, synthesize the design, and generate an
  implementation on your FPGA. 

\textbf{TA PASS OFF: Show and explain to your TA your simulation and implementation for your 4-bit ripple-carry adder. Show them your timing report you pulled for the 4-bit RC adder}
\end{enumerate}

\section{Design a 4-bit carry-select adder}
\begin{enumerate}
\item Simulate the 4-bit carry-select adder you designed in the
pre-lab work, then synthesize and implement it on your FPGA.
\item Generate the synthesis reports and see for yourself if the delay of the longest path improves or not. Would you expect the longest path to change? Why or why not? Also, observe what happens to the area of the circuit, as compared to that of the ripple carry design.

\textbf{TA PASS OFF: Show and explain to your TA your simulation and implementation for your 4-bit carry-select adder. Show them your timing report you pulled for the 4-bit CS adder}
\end{enumerate}

\section{Design 16-bit adders}
\begin{enumerate}
\item Construct a 16-bit ripple carry adder using hierarchical Verilog and your 4-bit ripple carry adder as a module. Simulate and synthesize your design, but you do not need to map your design to the FPGA.

\textbf{TA PASS OFF: Show and explain to your TA your simulation for your 16-bit ripple-carry adder.}

\item Construct a 16-bit carry-select adder using hierarchical Verilog and your 4-bit carry-select adder as a module. Simulate and synthesize your design, but you do not need to map your design to the FPGA.

\textbf{TA PASS OFF: Show and explain to your TA your simulation for your 16-bit carry-select adder.}

\item Examine the synthesis reports for your two 16-bit adder designs. Compare the area and delay of your designs. Comment on the advantages and disadvantages of each adder design.

\textbf{TA PASS OFF: Take your report of timing and sizes for all the adders you built and show it/explain it to your TA}
\end{enumerate}

\section{TA Checkoff}
\begin{itemize}
\item (40 points) Complete pre-lab work prior to start of the lab.
  \begin{itemize}
    %\item (30 points) 
    \item (20 points) Structural Verilog description of the 1-bit full
      adder, the 4-bit ripple-carry, and the 4-bit carry-select adders.
    \item (10 points) Delay calculation for 16-bit ripple-carry and
      carry-select adders.
    \item (10 points) Completed the Quiz
  \end{itemize}    
\item (10 points) Correct simulation and FPGA implementation of the
  4-bit ripple-carry adder.
\item (10 points) Correct simulation and FPGA implementation of the
  4-bit carry-select adder.
\item (10 points) Correct simulation results of the 16-bit
  ripple-carry adder.
\item (10 points) Correct simulation results of the 16-bit
  carry-select adder.
\item (20 points) Present a brief report with tabulated area and delay
  numbers for your 4-bit and 16-bit adders, and a summary of your observations paying particular attention to the questions asked above.
\end{itemize}

\end{document}